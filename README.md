# 两轮差速小车控制系统

## 项目概述

本项目实现了一个基于STM32的两轮差速小车控制系统，包含完整的电机速度闭环控制、平滑轨迹规划以及先进的控制算法。系统通过编码器反馈实现精确的速度控制，并提供多种优化策略以提高控制性能和运动平稳性。

## 核心功能

- **PI速度闭环控制**: 精确控制电机速度，支持自适应参数调整
- **S形加减速曲线**: 实现平滑的速度变化，避免机械冲击
- **卡尔曼滤波器**: 降低编码器噪声，提高速度估计精度
- **增益调度**: 根据不同速度范围自动调整PI参数
- **自动参数辨识**: 支持自动寻找最优控制参数

## 硬件要求

- STM32F1系列微控制器
- 两个直流减速电机(带编码器)
- 电机驱动模块(TB6612或类似)
- 编码器(13线霍尔编码器，30:1减速比)
- 轮子直径: 65mm
- 轮距: 177mm

## 软件架构

系统软件架构分为以下几个主要模块:

1. **电机控制模块 (motor.c/h)**
   - 速度计算与编码器读取
   - PI控制器实现
   - PWM输出控制

2. **速度规划模块 (speed_planning.c/h)**
   - S形加减速曲线生成
   - 基于实际速度的状态控制

3. **滤波模块**
   - 卡尔曼滤波器实现
   - 噪声抑制处理

4. **增益调度模块**
   - 根据速度范围动态调整PI参数
   - 提高全速域控制精度

5. **中断控制**
   - 500Hz控制频率
   - 实时响应处理

## 运动学模型

两轮差速小车的运动学逆解公式如下:

```
左轮速度 = Vx - Vz * Wheel_spacing / 2.0
右轮速度 = Vx + Vz * Wheel_spacing / 2.0
```

其中:
- Vx: 车体前进速度 (m/s)
- Vz: 车体旋转角速度 (rad/s)
- Wheel_spacing: 轮距 (m)

## 控制算法详解

### 1. 电机速度闭环控制

采用增量式PI控制器实现电机速度控制:

```
PWM += Kp * (当前误差 - 上次误差) + Ki * 当前误差
```

控制器通过比较编码器测量的实际速度与目标速度，计算电机的PWM输出值。

### 2. S形加减速曲线

七段式S曲线包含以下阶段:
- 加加速段(加速度上升)
- 匀加速段
- 减加速段(加速度下降)
- 匀速段
- 加减速段(减速度上升)
- 匀减速段
- 减减速段(减速度下降)

通过这种平滑的速度变化，系统可以减少机械振动和冲击，延长电机寿命。

### 3. 卡尔曼滤波

通过卡尔曼滤波算法处理编码器读数，有效降低测量噪声:

```
预测步骤: P = P + Q
更新步骤: K = P / (P + R)
         x = x + K * (测量值 - x)
         P = (1 - K) * P
```

### 4. 增益调度

系统根据不同速度区间使用不同的PI参数:
- 低速区域: 较大的Kp和Ki，用于克服静摩擦
- 中速区域: 中等Kp和Ki值
- 高速区域: 较小的Kp，避免系统振荡

## 使用方法

### 基本控制

使用以下函数设置目标速度:

```c
// 设置左右轮目标速度，带S形加减速
Set_Target_Speed_Smooth(0.05f, 0.05f);  // 左轮和右轮均以0.05m/s速度前进
```

### 参数调整

调整PI控制器参数:

```c
// 速度控制器参数调整
MOTOR_A.Velocity_KP = 300.0f;  // 比例增益
MOTOR_A.Velocity_KI = 300.0f;  // 积分增益
```

### 状态监测

可以通过OLED显示当前速度和目标速度:

```c
// 显示速度信息
sprintf((char*)OledString, "Va:%.2f/%.2f", speed_a, target_a);
OLED_ShowString(0, 0, (unsigned char*)OledString);

sprintf((char*)OledString, "Vb:%.2f/%.2f", speed_b, target_b);
OLED_ShowString(0, 1, (unsigned char*)OledString);
```

## 高级功能

### 开启自适应控制

```c
// 初始化增益调度器
GS_Init(&Motor_A_Scheduler, Motor_A_Ranges, sizeof(Motor_A_Ranges)/sizeof(Speed_Range));
GS_Init(&Motor_B_Scheduler, Motor_B_Ranges, sizeof(Motor_B_Ranges)/sizeof(Speed_Range));

// 启用自适应控制
Enable_Adaptive_Control(1);
```

### 执行自动参数辨识

```c
// 开始电机A自动调参
Start_Auto_Tuning(0);

// 开始电机B自动调参
Start_Auto_Tuning(1);

// 应用调参结果
Apply_Tuned_Parameters();
```

## 性能参数

- **控制频率**: 500Hz
- **速度范围**: ±0.1 m/s
- **加速度**: 最大0.2 m/s²
- **加加速度**: 最大0.5 m/s³
- **速度精度**: 0.001 m/s
- **响应时间**: <50ms

## 优化与调试

1. **卡尔曼滤波参数**:
   - Q值(0.001)控制过程噪声
   - R值(0.05)控制测量噪声
   - 增大R使滤波更强但响应变慢
   - 增大Q使响应更快但噪声增加

2. **S曲线参数**:
   - 匀速段时间影响加速过程
   - 加减速段时间影响平滑度
   - 加减速度值影响加速快慢

3. **PI参数选择**:
   - 增大Kp可提高响应速度但可能引入震荡
   - 增大Ki可减小稳态误差但可能引入超调

## 未来扩展

1. **多传感器融合**: 整合IMU数据实现更精确的运动控制
2. **自主导航**: 添加避障和路径规划算法
3. **动态参数调整**: 基于负载变化自动调整控制参数
4. **远程监控**: 添加无线通信模块实现远程参数调整和监控

## 故障排查

1. **电机不转**:
   - 检查电源和电机连接
   - 检查PWM输出是否正常
   - 确认使能信号正常

2. **速度不稳**:
   - 调整PI控制参数
   - 检查编码器是否正常工作
   - 增大卡尔曼滤波的R值

3. **无法达到目标速度**:
   - 检查电池电压是否足够
   - 调整PI控制参数
   - 确认电机和机械系统无阻碍

## 总结

本两轮差速小车控制系统结合了多种先进控制算法，实现了平稳、精确的运动控制。通过卡尔曼滤波、S形加减速曲线和增益调度等技术，系统能够适应不同工况，提供稳定可靠的性能，适用于室内导航、服务机器人等多种应用场景。
